<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <link
      href="{{ url_for('static', filename='style.css') }}"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"
      integrity="sha384-Akqfrbj/HpNVo8k11SXBb6TlBWmXXlYQrCSqEWmyKJe+hDm3Z/B2WVG4smwBkRVm"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-900 text-slate-200">
    <div class="container mx-auto px-4 py-8">
      <div class="flex flex-row justify-between mb-4">
        <h1 class="text-4xl font-bold mb-4 text-blue-300">{{ title }}</h1>
        <img
          class="w-16 transition-transform duration-300 hover:scale-[4] origin-top-right active:scale-[4]"
          src="data:image/png;base64,{{ qrcode }}"
        />
      </div>
      <form
        hx-get="/"
        hx-target="#songs-table"
        hx-trigger="change, keyup delay:400ms"
        hx-indicator="#loading"
        class="mb-6"
      >
        <div class="flex flex-wrap gap-4">
          <div class="flex-1 min-w-48">
            <input
              type="text"
              id="search"
              name="search"
              value="{{ search }}"
              class="w-full px-4 py-2 border border-slate-600 rounded-md bg-slate-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
              placeholder="Search by artist, title, or genre..."
            />
          </div>
        </div>
      </form>

      <div id="loading" class="htmx-indicator mb-4">
        <div
          class="flex items-center justify-center p-4 bg-slate-800 rounded-lg"
        >
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"
          ></div>
          <span class="ml-2 text-slate-300">Loading songs ...</span>
        </div>
      </div>

      <div id="songs-table">{% include 'songs_table.html' %}</div>
    </div>

    <script>
      let currentAudio = null;
      let currentPlayingButton = null;

      // Handle play/pause button click event
      document.addEventListener("click", function (event) {
        if (event.target.classList.contains("play-button")) {
          const button = event.target;
          const songId = button.getAttribute("song_id");
          const previewOffset =
            parseFloat(button.getAttribute("preview_offset")) || 0;

          // If this is the currently playing song, pause it
          if (
            currentPlayingButton &&
            currentPlayingButton.getAttribute("song_id") === songId
          ) {
            if (currentAudio) {
              currentAudio.pause();
              currentAudio = null;
            }
            button.textContent = "▶";
            button.setAttribute("title", "Play");
            currentPlayingButton = null;
            event.preventDefault();
            return;
          }

          // Stop any currently playing audio
          if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
          }

          // Reset the previous playing button
          if (currentPlayingButton) {
            currentPlayingButton.textContent = "▶";
            currentPlayingButton.setAttribute("title", "Play");
          }

          // Create and play new audio
          const audio = new Audio("/api/mp3?song_id=" + songId);

          // Set the preview offset when the audio is loaded
          audio.addEventListener("loadedmetadata", function () {
            if (previewOffset > 0) {
              audio.currentTime = previewOffset;
            }
          });

          audio.play();

          // Update current state
          currentAudio = audio;
          currentPlayingButton = button;
          button.textContent = "⏸";
          button.setAttribute("title", "Pause");

          // Handle audio end event
          audio.onended = function () {
            if (currentPlayingButton) {
              currentPlayingButton.textContent = "▶";
              currentPlayingButton.setAttribute("title", "Play");
              currentPlayingButton = null;
            }
            currentAudio = null;
          };

          event.preventDefault();
        }
      });

      // Handle HTMX after swap events to ensure play buttons work on dynamically loaded content
      document.body.addEventListener("htmx:afterSwap", function (event) {
        // The event listeners are already set up via event delegation above
        console.log("Content swapped, play buttons ready");
      });
    </script>
  </body>
</html>
