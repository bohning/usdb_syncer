<!DOCTYPE html>
<html>

<head>
    <title>Ultrastar Song DB</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script> -->
</head>

<body class="bg-gray-900">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-4 text-white">Ultrastar Song DB</h1>
        <form hx-get="/" hx-target="#songs-table" hx-trigger="change, keyup delay:300ms" hx-indicator="#loading" class="mb-6">
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-48">
                    <input type="text" id="search" name="search" value="{{ search }}"
                        class="w-full px-4 py-2 border border-gray-600 rounded-md bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                        placeholder="Type to search ...">
                </div>
                <div class="flex-1 min-w-48">
                    <label for="sort_by" class="block text-sm font-medium text-white mb-1">Sort by:</label>
                    <select id="sort_by" name="sort_by"
                        class="w-full px-4 py-2 border border-gray-600 rounded-md bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        <option value="artist" {% if sort_by=='artist' %}selected{% endif %}>Artist</option>
                        <option value="title" {% if sort_by=='title' %}selected{% endif %}>Title</option>
                        <option value="genre" {% if sort_by=='genre' %}selected{% endif %}>Genre</option>
                        <option value="year" {% if sort_by=='year' %}selected{% endif %}>Year</option>
                    </select>
                </div>
            </div>
        </form>

        <div id="loading" class="htmx-indicator mb-4">
            <div class="flex items-center justify-center p-4 bg-gray-800 rounded-lg">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <span class="ml-2 text-gray-300">Loading songs ...</span>
            </div>
        </div>
        
        <p class="mb-2 text-gray-300 text-sm">Showing {{ songs|length }} songs.</p>
        
        <div id="songs-table">
            {% include 'songs_table.html' %}
        </div>

    <script>
        let currentAudio = null;
        let currentPlayingButton = null;

        // Handle play/pause button click event
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('play-button')) {
                const button = event.target;
                const songId = button.getAttribute('song_id');
                const previewOffset = parseFloat(button.getAttribute('preview_offset')) || 0;
                
                // If this is the currently playing song, pause it
                if (currentPlayingButton && currentPlayingButton.getAttribute('song_id') === songId) {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    button.textContent = '▶';
                    button.setAttribute('title', 'Play');
                    currentPlayingButton = null;
                    event.preventDefault();
                    return;
                }
                
                // Stop any currently playing audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                // Reset the previous playing button
                if (currentPlayingButton) {
                    currentPlayingButton.textContent = '▶';
                    currentPlayingButton.setAttribute('title', 'Play');
                }
                
                // Create and play new audio
                const audio = new Audio('/api/mp3?song_id=' + songId);
                
                // Set the preview offset when the audio is loaded
                audio.addEventListener('loadedmetadata', function() {
                    if (previewOffset > 0) {
                        audio.currentTime = previewOffset;
                    }
                });
                
                audio.play();
                
                // Update current state
                currentAudio = audio;
                currentPlayingButton = button;
                button.textContent = '⏸';
                button.setAttribute('title', 'Pause');
                
                // Handle audio end event
                audio.onended = function() {
                    if (currentPlayingButton) {
                        currentPlayingButton.textContent = '▶';
                        currentPlayingButton.setAttribute('title', 'Play');
                        currentPlayingButton = null;
                    }
                    currentAudio = null;
                };
                
                event.preventDefault();
            }
        });

        // Handle HTMX after swap events to ensure play buttons work on dynamically loaded content
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // The event listeners are already set up via event delegation above
            console.log('Content swapped, play buttons ready');
        });
    </script>
</body>

</html>